<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Weather Dashboard</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for the forecast chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- D3.js and TopoJSON for the interactive globe -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.8s ease-in-out, color 0.8s ease-in-out;
        }
        /* Animation for elements fading in on load */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }
        
        /* --- DYNAMIC THEME STYLES --- */
        /* Default Theme (Cloudy) */
        :root {
            --bg-color: #d1d5db;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --card-bg: rgba(255, 255, 255, 0.6);
            --card-border: rgba(209, 213, 219, 0.8);
            --chart-grid: rgba(107, 114, 128, 0.2);
            --globe-water: #a5c1d9;
            --globe-land: #ffffff;
            --globe-marker: #ef4444;
        }
        
        /* Sunny Theme */
        .theme-sunny {
            --bg-color: #fcd34d;
            --text-primary: #78350f;
            --text-secondary: #9a3412;
            --card-bg: rgba(255, 251, 235, 0.6);
            --card-border: rgba(252, 211, 77, 0.8);
            --chart-grid: rgba(217, 119, 6, 0.2);
            --globe-water: #fbbf24;
            --globe-land: #fffbeb;
            --globe-marker: #dc2626;
        }

        /* Rainy Theme */
        .theme-rainy {
            --bg-color: #6b7280;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --card-bg: rgba(55, 65, 81, 0.5);
            --card-border: rgba(107, 114, 128, 0.8);
            --chart-grid: rgba(209, 213, 219, 0.2);
            --globe-water: #4b5563;
            --globe-land: #9ca3af;
            --globe-marker: #f87171;
        }

        /* Snowy Theme */
        .theme-snowy {
            --bg-color: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #374151;
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(209, 213, 219, 0.9);
            --chart-grid: rgba(75, 85, 99, 0.2);
            --globe-water: #d1d5db;
            --globe-land: #f9fafb;
            --globe-marker: #ef4444;
        }

        /* Night Theme */
        .theme-night {
            --bg-color: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --card-bg: rgba(55, 65, 81, 0.5);
            --card-border: rgba(75, 85, 99, 0.8);
            --chart-grid: rgba(156, 163, 175, 0.2);
            --globe-water: #374151;
            --globe-land: #6b7280;
            --globe-marker: #fca5a5;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
        }
        .themed-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .themed-text-secondary { color: var(--text-secondary); }
        #globe-container {
            height: 350px; /* Increased height for a bigger globe */
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }
        #globe-container svg {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- SVG Icons Definition -->
    <svg width="0" height="0" class="absolute">
        <defs>
            <symbol id="icon-sun" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1m0 14a1 1 0 0 1 1 1v2a1 1 0 1 1-2 0v-2a1 1 0 0 1 1-1m8.66-11.66a1 1 0 0 1 .71.29l1.41 1.41a1 1 0 0 1-1.42 1.42l-1.41-1.41a1 1 0 0 1 .71-1.71M3.34 19.25a1 1 0 0 1 .71.29l1.41 1.41a1 1 0 0 1-1.42 1.42l-1.41-1.41a1 1 0 0 1 .71-1.71m15.91-8.24a1 1 0 0 1 0 1.42l-1.41 1.41a1 1 0 0 1-1.42-1.42l1.41-1.41a1 1 0 0 1 1.42 0M4.75 4.75a1 1 0 0 1 0 1.42L3.34 7.58a1 1 0 0 1-1.42-1.42L3.34 4.75a1 1 0 0 1 1.42 0M21 12a1 1 0 0 1-1 1h-2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1M5 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h2a1 1 0 0 1 1 1m7-5a4 4 0 1 0 4 4a4 4 0 0 0-4-4"/></symbol>
            <symbol id="icon-cloud" viewBox="0 0 24 24"><path fill="currentColor" d="M5.5 12.5a5.5 5.5 0 0 1 10.4 2.5H16a4 4 0 1 1 0 8H6a4 4 0 1 1-1.1-7.8a5.5 5.5 0 0 1 .6-2.7"/></symbol>
            <symbol id="icon-rain" viewBox="0 0 24 24"><path fill="currentColor" d="M12 6.5a5.5 5.5 0 0 1 10.4 2.5H23a4 4 0 1 1 0 8H13a4 4 0 1 1-1.1-7.8a5.5 5.5 0 0 1 .1-2.7m-2.2 11.3a1 1 0 1 0-1.6 1.2l1 1.2a1 1 0 1 0 1.6-1.2l-1-1.2m4-3a1 1 0 1 0-1.6 1.2l1 1.2a1 1 0 1 0 1.6-1.2l-1-1.2m-6 2a1 1 0 1 0-1.6 1.2l1 1.2a1 1 0 1 0 1.6-1.2l-1-1.2"/></symbol>
            <symbol id="icon-snow" viewBox="0 0 24 24"><path fill="currentColor" d="M5.5 12.5a5.5 5.5 0 0 1 10.4 2.5H16a4 4 0 1 1 0 8H6a4 4 0 1 1-1.1-7.8a5.5 5.5 0 0 1 .6-2.7m6.5 6l.9.9l-.9.9V21a1 1 0 1 1-2 0v-.7l-.9-.9l.9-.9l.9.9m2.5-4.5l.9.9l-.9.9v.7a1 1 0 1 1-2 0v-.7l-.9-.9l.9-.9l.9.9m-5 0l.9.9l-.9.9v.7a1 1 0 1 1-2 0v-.7l-.9-.9l.9-.9l.9.9m2.5-4.5l.9.9l-.9.9v.7a1 1 0 1 1-2 0v-.7l-.9-.9l.9-.9l.9.9"/></symbol>
            <symbol id="icon-storm" viewBox="0 0 24 24"><path fill="currentColor" d="M17.5 12.5a5.5 5.5 0 0 1-1.1 10.3H6a4 4 0 1 1 0-8h.1a5.5 5.5 0 0 1 10.3-4.7l1.1.1M13 19l-2 3h3l-1-4l-2 3m3-1l2-3h-3l1 4"/></symbol>
            <symbol id="icon-moon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 21a9 9 0 1 1 6.1-15.5a.5.5 0 0 0-.3 1a7 7 0 1 0 5.2 5.2a.5.5 0 0 0 1 .3A9 9 0 0 1 12 21"/></symbol>
        </defs>
    </svg>

    <main id="weather-container" class="min-h-screen w-full p-4 md:p-8 flex flex-col items-center justify-center opacity-0 transition-opacity duration-1000">
        
        <!-- Search Bar -->
        <div class="w-full max-w-xl mb-8">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search for a city..." class="w-full py-3 px-4 pr-10 rounded-full themed-card themed-text-secondary placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white/50 transition">
                <button id="search-btn" class="absolute top-1/2 right-3 -translate-y-1/2 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
            </div>
        </div>

        <div class="themed-card w-full max-w-6xl rounded-3xl shadow-2xl p-6 md:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <div id="current-weather" class="fade-in">
                        <p id="city-name" class="text-2xl md:text-3xl font-bold">Loading...</p>
                        <div class="flex items-end space-x-4 mt-2">
                            <p id="current-temp" class="text-7xl md:text-8xl font-extrabold">--°</p>
                            <div class="flex items-center space-x-3">
                                <svg id="weather-icon" class="w-16 h-16"><use href=""></use></svg>
                                <p id="weather-description" class="text-lg font-medium">Fetching...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Globe Section -->
                    <div class="fade-in" style="animation-delay: 200ms;">
                         <h2 class="text-xl font-bold mb-4">Location</h2>
                         <div id="globe-container"></div>
                    </div>

                    <div class="fade-in" style="animation-delay: 400ms;">
                        <h2 class="text-xl font-bold mb-4">Hourly Forecast</h2>
                        <div class="h-64 md:h-80">
                            <canvas id="forecast-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-8">
                    <div class="fade-in" style="animation-delay: 600ms;">
                        <h2 class="text-xl font-bold mb-4">Details</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-black/10 p-4 rounded-xl text-center"><p class="text-sm themed-text-secondary">Sunrise</p><p id="sunrise" class="text-xl font-bold mt-1">--:--</p></div>
                            <div class="bg-black/10 p-4 rounded-xl text-center"><p class="text-sm themed-text-secondary">Sunset</p><p id="sunset" class="text-xl font-bold mt-1">--:--</p></div>
                            <div class="bg-black/10 p-4 rounded-xl text-center"><p class="text-sm themed-text-secondary">Humidity</p><p id="humidity" class="text-xl font-bold mt-1">--%</p></div>
                            <div class="bg-black/10 p-4 rounded-xl text-center"><p class="text-sm themed-text-secondary">Wind</p><p id="wind-speed" class="text-xl font-bold mt-1">-- km/h</p></div>
                            <div class="bg-black/10 p-4 rounded-xl text-center"><p class="text-sm themed-text-secondary">UV Index</p><p id="uv-index" class="text-xl font-bold mt-1">--</p></div>
                            <div class="bg-black/10 p-4 rounded-xl text-center"><p class="text-sm themed-text-secondary">Visibility</p><p id="visibility" class="text-xl font-bold mt-1">-- km</p></div>
                        </div>
                    </div>
                    <div class="fade-in" style="animation-delay: 800ms;">
                        <h2 class="text-xl font-bold mb-4">5-Day Forecast</h2>
                        <div id="daily-forecast" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const weatherContainer = document.getElementById('weather-container');
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const cityNameEl = document.getElementById('city-name');
            const currentTempEl = document.getElementById('current-temp');
            const weatherIconEl = document.getElementById('weather-icon').querySelector('use');
            const weatherDescriptionEl = document.getElementById('weather-description');
            const sunriseEl = document.getElementById('sunrise');
            const sunsetEl = document.getElementById('sunset');
            const humidityEl = document.getElementById('humidity');
            const windSpeedEl = document.getElementById('wind-speed');
            const uvIndexEl = document.getElementById('uv-index');
            const visibilityEl = document.getElementById('visibility');
            const dailyForecastEl = document.getElementById('daily-forecast');
            const forecastChartCanvas = document.getElementById('forecast-chart');
            let forecastChart;
            
            // Globe variables
            let projection, path, svg, land, marker;
            const globeContainer = document.getElementById('globe-container');

            function initGlobe() {
                const width = globeContainer.offsetWidth;
                const height = globeContainer.offsetHeight;

                projection = d3.geoOrthographic()
                    .scale(height / 1.9) // Adjusted for a larger initial globe
                    .translate([width / 2, height / 2])
                    .clipAngle(90);

                path = d3.geoPath().projection(projection);

                svg = d3.select("#globe-container").append("svg")
                    .attr("width", width)
                    .attr("height", height);

                svg.append("path")
                    .datum({ type: "Sphere" })
                    .attr("class", "water")
                    .attr("d", path)
                    .style("fill", "var(--globe-water)");

                d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(world => {
                    land = svg.append("path")
                        .datum(topojson.feature(world, world.objects.countries))
                        .attr("class", "land")
                        .attr("d", path)
                        .style("fill", "var(--globe-land)");
                    
                    marker = svg.append("circle")
                        .attr("r", 5)
                        .attr("class", "marker")
                        .style("fill", "var(--globe-marker)");

                    getUserLocation(); // Get location after globe is ready
                });
            }
            
            function updateGlobe(lat, lon) {
                const height = globeContainer.offsetHeight;
                const targetScale = height / 1.5; // Target for a more "zoomed-in" feel

                d3.transition()
                    .duration(1500)
                    .tween("rotate.zoom", function() {
                        const r = d3.interpolate(projection.rotate(), [-lon, -lat]);
                        const s = d3.interpolate(projection.scale(), targetScale);
                        return function(t) {
                            projection.rotate(r(t));
                            projection.scale(s(t));
                            svg.selectAll("path.land").attr("d", path);
                            const coords = projection([lon, lat]);
                            marker.attr("cx", coords[0]).attr("cy", coords[1]);
                        };
                    });
            }

            function getUserLocation() {
                navigator.geolocation ? navigator.geolocation.getCurrentPosition(pos => getWeatherData(pos.coords.latitude, pos.coords.longitude), () => getWeatherData(51.5072, -0.1276)) : getWeatherData(51.5072, -0.1276);
            }

            async function getCityCoords(city) {
                try {
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=en&format=json`);
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const { latitude, longitude, name } = data.results[0];
                        getWeatherData(latitude, longitude, name);
                    } else {
                        alert('City not found. Please try again.');
                    }
                } catch(error) {
                    console.error("Error fetching city coordinates:", error);
                }
            }

            async function getWeatherData(lat, lon, forcedCityName = null) {
                try {
                    let cityName = forcedCityName;
                    if (!cityName) {
                        const geoResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                        const geoData = await geoResponse.json();
                        cityName = geoData.city || geoData.locality || 'Unknown Location';
                    }

                    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m&hourly=temperature_2m,visibility&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max&timezone=auto`;
                    const weatherResponse = await fetch(weatherUrl);
                    const weatherData = await weatherResponse.json();

                    renderCurrentWeather(weatherData.current, cityName, weatherData.daily, weatherData.hourly);
                    renderDailyForecast(weatherData.daily);
                    createOrUpdateForecastChart(weatherData.hourly);
                    updateTheme(weatherData.current.weather_code, weatherData.current.is_day);
                    updateGlobe(lat, lon);
                    
                    weatherContainer.style.opacity = 1;
                } catch (error) {
                    console.error("Error fetching weather data:", error);
                    cityNameEl.textContent = "Could not fetch weather data.";
                }
            }

            function renderCurrentWeather(current, cityName, daily, hourly) {
                const weatherInfo = getWeatherInfo(current.weather_code, current.is_day);
                cityNameEl.textContent = cityName;
                currentTempEl.textContent = `${Math.round(current.temperature_2m)}°`;
                weatherIconEl.setAttribute('href', weatherInfo.icon);
                weatherDescriptionEl.textContent = weatherInfo.description;
                humidityEl.textContent = `${current.relative_humidity_2m}%`;
                windSpeedEl.textContent = `${Math.round(current.wind_speed_10m)} km/h`;
                uvIndexEl.textContent = Math.round(daily.uv_index_max[0]);
                visibilityEl.textContent = `${Math.round(hourly.visibility[0] / 1000)} km`;
                sunriseEl.textContent = new Date(daily.sunrise[0]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                sunsetEl.textContent = new Date(daily.sunset[0]).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            function renderDailyForecast(daily) {
                dailyForecastEl.innerHTML = '';
                for (let i = 1; i < 6; i++) {
                    const day = new Date(daily.time[i]);
                    const dayName = day.toLocaleDateString('en-US', { weekday: 'short' });
                    const weatherInfo = getWeatherInfo(daily.weather_code[i], 1); // Assume day for forecast icons

                    const forecastItem = document.createElement('div');
                    forecastItem.className = 'flex items-center justify-between bg-black/10 p-3 rounded-lg';
                    forecastItem.innerHTML = `
                        <p class="font-medium w-1/4">${dayName}</p>
                        <svg class="w-8 h-8"><use href="${weatherInfo.icon}"></use></svg>
                        <div class="text-right w-1/3">
                            <span class="font-bold">${Math.round(daily.temperature_2m_max[i])}°</span>
                            <span class="themed-text-secondary ml-2">${Math.round(daily.temperature_2m_min[i])}°</span>
                        </div>
                    `;
                    dailyForecastEl.appendChild(forecastItem);
                }
            }
            
            function createOrUpdateForecastChart(hourly) {
                const ctx = forecastChartCanvas.getContext('2d');
                const labels = hourly.time.slice(0, 24).map(t => new Date(t));
                const dataPoints = hourly.temperature_2m.slice(0, 24);

                if (forecastChart) {
                    forecastChart.data.labels = labels;
                    forecastChart.data.datasets[0].data = dataPoints;
                    forecastChart.update();
                } else {
                    forecastChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Temperature (°C)',
                                data: dataPoints,
                                fill: true,
                                backgroundColor: 'rgba(255, 255, 255, 0.1)',
                                borderColor: 'rgba(255, 255, 255, 0.8)',
                                tension: 0.4,
                                pointBackgroundColor: 'white'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: { unit: 'hour' },
                                    ticks: { color: 'var(--text-secondary)' },
                                    grid: { color: 'var(--chart-grid)' }
                                },
                                y: {
                                    ticks: { color: 'var(--text-secondary)' },
                                    grid: { color: 'var(--chart-grid)' }
                                }
                            }
                        }
                    });
                }
            }

            function updateTheme(weatherCode, isDay) {
                let theme = 'theme-cloudy'; // Default
                if (!isDay) {
                    theme = 'theme-night';
                } else if (weatherCode <= 1) {
                    theme = 'theme-sunny';
                } else if ((weatherCode >= 51 && weatherCode <= 67) || (weatherCode >= 80 && weatherCode <= 82)) {
                    theme = 'theme-rainy';
                } else if ((weatherCode >= 71 && weatherCode <= 77) || (weatherCode >= 85 && weatherCode <= 86)) {
                    theme = 'theme-snowy';
                }
                document.body.className = theme;
                // Update globe colors
                if(svg) {
                    svg.select(".water").style("fill", getComputedStyle(document.documentElement).getPropertyValue('--globe-water'));
                    svg.select(".land").style("fill", getComputedStyle(document.documentElement).getPropertyValue('--globe-land'));
                    svg.select(".marker").style("fill", getComputedStyle(document.documentElement).getPropertyValue('--globe-marker'));
                }
            }

            function getWeatherInfo(code, isDay = 1) {
                const map = {
                    0: { d: "Clear", i: "#icon-sun" }, 1: { d: "Mainly Clear", i: "#icon-sun" },
                    2: { d: "Partly Cloudy", i: "#icon-cloud" }, 3: { d: "Overcast", i: "#icon-cloud" },
                    45: { d: "Fog", i: "#icon-cloud" }, 48: { d: "Rime Fog", i: "#icon-cloud" },
                    51: { d: "Light Drizzle", i: "#icon-rain" }, 53: { d: "Drizzle", i: "#icon-rain" }, 55: { d: "Dense Drizzle", i: "#icon-rain" },
                    61: { d: "Slight Rain", i: "#icon-rain" }, 63: { d: "Rain", i: "#icon-rain" }, 65: { d: "Heavy Rain", i: "#icon-rain" },
                    71: { d: "Slight Snow", i: "#icon-snow" }, 73: { d: "Snow", i: "#icon-snow" }, 75: { d: "Heavy Snow", i: "#icon-snow" },
                    80: { d: "Rain Showers", i: "#icon-rain" }, 81: { d: "Rain Showers", i: "#icon-rain" }, 82: { d: "Violent Showers", i: "#icon-rain" },
                    85: { d: "Snow Showers", i: "#icon-snow" }, 86: { d: "Heavy Snow Showers", i: "#icon-snow" },
                    95: { d: "Thunderstorm", i: "#icon-storm" }
                };
                const info = map[code] || { d: "Unknown", i: "#icon-cloud" };
                if (!isDay && info.i === '#icon-sun') {
                    return { description: info.d, icon: '#icon-moon' };
                }
                return { description: info.d, icon: info.i };
            }

            searchBtn.addEventListener('click', () => {
                if (searchInput.value) getCityCoords(searchInput.value);
            });
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && searchInput.value) getCityCoords(searchInput.value);
            });

            initGlobe();
        });
    </script>
</body>
</html>
